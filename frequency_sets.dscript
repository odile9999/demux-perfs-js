////////////////////////////////////////////////////////////////////////////////
function carrier_freq2(fgridratio, nbcarriers)
// This function computes the set of carrier frequencies
	{
	switch (nbcarriers) {
		case 1:  // 1 carrier at Fs/4
			// Sampling frequency:          19530000 Hz
			// Mean frequency spacing:        N/A
			// 1-sigma frequency dispersion:    0 Hz
			// Frequency grid:                  Fs/4
		    // Crest factor: 1.41
			// Set of carrier frequencies (Hz):
			freqtab=[19530000./4.];
		   	// Set of carrier initial phases (Deg):
   			phitab=[0];
			break;
		
		case 2:  // 2 carriers at Fs/8 and Fs/4
			// Sampling frequency:          19530000 Hz
			// Mean frequency spacing:        N/A
			// 1-sigma frequency dispersion:    0 Hz
			// Frequency grid:                  Fs/4
		    // Crest factor: 1.41
			// Set of carrier frequencies (Hz):
			freqtab=[19530000./8., 19530000./4.];
		   	// Set of carrier initial phases (Deg):
   			phitab=[0, 90];
			break;
		
		case 20:
			// Sampling frequency:          19530000 Hz
			// Mean frequency spacing:        200000 Hz
			// 1-sigma frequency dispersion:    2000 Hz
			// Frequency grid:                  2384 Hz
		    // Crest factor: 2.87
			// Set of carrier frequencies (Hz):
			freqtab=[
				998909.91211, 1196784.66797, 1404195.55664, 1597302.24609, 1802329.10156, 2004971.92383, 2200462.64648, 2403105.46875,
				2598596.19141, 2796470.94727, 2999113.76953, 3204140.62500, 3399631.34766, 3599890.13672, 3797764.89258, 4000407.71484, 
				4207818.60352, 4398541.25977, 4598800.04883, 4801442.87109
				];
		   	// Set of carrier initial phases (Deg):
   			phitab=[
				219.55078, 109.24805, 208.47656, 228.25195, 63.72070, 249.96094, 208.91602, 104.23828,
				328.44727, 159.25781, 129.28711, 187.20703, 152.31445, 149.85352, 160.48828, 50.18555, 
				207.77344, 187.55859, 344.26758, 38.58398
				];
			break;

		default:   // 40 carriers
			switch (fgridratio) {
				case Math.pow(2,8):		
					// Sampling frequency:          19530000 Hz
					// Frequency spacing:        76289 Hz
					// 1-sigma frequency dispersion:    0 Hz
					// Frequency grid:                  76289 Hz
					// Crest factor: 2.92
					// Set of carrier frequencies (Hz):
					freqtab=[
						991757.81250, 1068046.87500, 1144335.93750, 1220625.00000, 1296914.06250, 1373203.12500, 1449492.18750, 1525781.25000,
						1602070.31250, 1678359.37500, 1754648.43750, 1830937.50000, 1907226.56250, 1983515.62500, 2059804.68750, 2136093.75000,
						2212382.81250, 2288671.87500, 2364960.93750, 2441250.00000, 2517539.06250, 2593828.12500, 2670117.18750, 2746406.25000,
						2822695.31250, 2898984.37500, 2975273.43750, 3051562.50000, 3127851.56250, 3204140.62500, 3280429.68750, 3356718.75000,
						3433007.81250, 3509296.87500, 3585585.93750, 3661875.00000, 3738164.06250, 3814453.12500, 3890742.18750, 3967031.25000
						];
					// Set of carrier initial phases (Deg):
					phitab=[
						242.13867, 39.72656, 129.63867, 119.53125, 1.84570, 273.33984, 151.08398, 104.41406,
						176.30859, 300.05859, 128.84766, 202.85156, 135.08789, 357.01172, 187.99805, 238.53516,
						161.27930, 175.07812, 185.36133, 167.69531, 77.69531, 270.70313, 69.78516, 174.02344,
						286.96289, 347.34375, 319.65820, 39.11133, 334.33594, 208.47656, 350.41992, 36.38672,
						98.43750, 320.27344, 313.68164, 221.57227, 116.19141, 305.68359, 151.87500, 130.95703
						];
					break;

				case Math.pow(2,13):
					// Sampling frequency:          19530000 Hz
					// Mean frequency spacing:        100000 Hz
					// 1-sigma frequency dispersion:    2000 Hz
					// Frequency grid:                  2384 Hz
					// Crest factor: 2.8736
					// Set of carrier frequencies (Hz):
					freqtab=[
						996525.8789062, 1094271.2402344, 1196784.6679688, 1299298.0957031, 1399427.4902344, 1499556.8847656, 1599686.2792969, 1697431.6406250,
						1799945.0683594, 1902458.4960938, 2000203.8574219, 2097949.2187500, 2198078.6132812, 2300592.0410156, 2400721.4355469, 2498466.7968750,
						2600980.2246094, 2696341.5527344, 2798854.9804688, 2896600.3417969, 2996729.7363281, 3099243.1640625, 3199372.5585938, 3299501.9531250,
						3397247.3144531, 3499760.7421875, 3602274.1699219, 3697635.4980469, 3800148.9257812, 3897894.2871094, 3998023.6816406, 4100537.1093750,
						4200666.5039062, 4296027.8320312, 4400925.2929688, 4498670.6542969, 4598800.0488281, 4698929.4433594, 4799058.8378906, 4899188.2324219
						];
					// Set of carrier initial phases (Deg):
					phitab=[
						   107.7727850,    203.1627632,    298.8801967,    127.5994160,    188.5333522,      2.4112296,     67.1484022,    171.1652201,
						   150.8047598,    322.1950151,    130.0851989,     81.4760375,    122.0745452,     50.3190029,    241.3635474,    325.3371947,
						   347.0680053,    355.4681262,    255.6400237,    168.1738017,    299.6908905,     48.5313223,     62.9947822,    170.4643769,
						   206.6976474,    151.1035278,     36.3290275,    131.4925075,     21.9212012,    265.7612321,    144.8605492,    270.6517507,
						   326.9658489,    349.3146804,    313.9478634,     73.1778711,    129.7487013,    132.9821082,    205.3450111,    139.3232841
					];
					break;

				case Math.pow(2,14):
					// Sampling frequency:          19530000 Hz
					// Mean frequency spacing:        100000 Hz
					// 1-sigma frequency dispersion:    2000 Hz
					// Frequency grid:                  1192 Hz
					// Crest factor: 3.15
					// Set of carrier frequencies (Hz):
					freqtab=[
						1002485.96191, 1096655.27344, 1199168.70117, 1300490.11230, 1399427.49023, 1499556.88477, 1597302.24609, 1697431.64062,
						1797561.03516, 1896498.41309, 2001395.87402, 2100333.25195, 2200462.64648, 2298208.00781, 2400721.43555, 2496082.76367,
						2600980.22461, 2699917.60254, 2802431.03027, 2902560.42480, 3001497.80273, 3100435.18066, 3196988.52539, 3299501.95312,
						3399631.34766, 3498568.72559, 3599890.13672, 3701211.54785, 3801340.94238, 3901470.33691, 3998023.68164, 4102921.14258,
						4200666.50391, 4297219.84863, 4398541.25977, 4498670.65430, 4602376.09863, 4702505.49316, 4799058.83789, 4896804.19922
						];
					// Set of carrier initial phases (Deg):
					phitab=[
						188.96484, 231.59180, 303.48633, 74.79492, 75.76172, 29.17969, 347.25586, 350.06836,
						130.42969, 350.68359, 43.06641, 205.75195, 30.84961, 223.85742, 69.52148, 308.75977,
						128.40820, 154.95117, 82.52930, 82.88086, 165.49805, 142.73438, 137.28516, 339.16992,
						49.13086, 167.69531, 279.31641, 110.83008, 38.49609, 36.82617, 276.76758, 42.09961,
						119.53125, 200.12695, 69.78516, 225.08789, 347.51953, 283.00781, 348.31055, 184.13086
						];
					break;

				case Math.pow(2,15):
					// Sampling frequency:          19530000 Hz
					// Mean frequency spacing:        100000 Hz
					// 1-sigma frequency dispersion:    2000 Hz
					// Frequency grid:                   596 Hz
					// Crest factor: 3.36
					// Set of carrier frequencies (Hz):
					freqtab=[
						997121.88721, 1098443.29834, 1200360.71777, 1302874.14551, 1401215.51514, 1500748.90137, 1599090.27100, 1700411.68213,
						1799945.06836, 1902458.49609, 1999607.84912, 2102121.27686, 2203442.68799, 2298804.01611, 2401317.44385, 2499062.80518,
						2602768.24951, 2701109.61914, 2803027.03857, 2900176.39160, 3002689.81934, 3099839.17236, 3198776.55029, 3298905.94482,
						3399631.34766, 3502740.78369, 3598102.11182, 3700019.53125, 3801340.94238, 3899682.31201, 4000407.71484, 4101133.11768,
						4200666.50391, 4297815.85693, 4399137.26807, 4502246.70410, 4598204.04053, 4697737.42676, 4799058.83789, 4899188.23242
						];
					// Set of carrier initial phases (Deg):
					phitab=[
						268.85742, 96.94336, 277.64648, 129.90234, 50.00977, 333.54492, 40.42969, 171.73828,
						215.33203, 160.31250, 23.29102, 138.60352, 41.66016, 281.60156, 162.77344, 28.65234,
						283.27148, 41.13281, 168.75000, 163.12500, 273.77930, 246.18164, 31.99219, 97.64648,
						143.08594, 173.93555, 69.25781, 342.33398, 112.85156, 211.02539, 262.79297, 104.85352,
						59.32617, 321.06445, 175.16602, 20.21484, 357.80273, 160.83984, 31.90430, 347.78320
						];
					break;

				case Math.pow(2,16):
					// Sampling frequency:          19530000 Hz
					// Mean frequency spacing:        100000 Hz
					// 1-sigma frequency dispersion:    2000 Hz
					// Frequency grid:                   298 Hz
					// Crest factor: 3.54
					// Set of carrier frequencies (Hz):
					freqtab=[
						1001293.94531, 1098741.30249, 1197678.68042, 1296914.06250, 1400917.51099, 1499556.88477, 1599984.28345, 1698623.65723,
						1802329.10156, 1899478.45459, 2000203.85742, 2102419.28101, 2201356.65894, 2305360.10742, 2399231.41479, 2501446.83838,
						2600086.21216, 2697235.56519, 2797960.96802, 2901666.41235, 2998815.76538, 3103415.22217, 3201458.58765, 3302779.99878,
						3400525.36011, 3502740.78369, 3597804.10767, 3701211.54785, 3798360.90088, 3902364.34937, 3998321.68579, 4103517.15088,
						4197686.46240, 4299007.87354, 4401223.29712, 4499862.67090, 4602078.09448, 4698035.43091, 4802038.87939, 4901572.26562
						];
					// Set of carrier initial phases (Deg):
					phitab=[
						355.60547, 344.97070, 52.03125, 145.63477, 183.77930, 46.66992, 296.98242, 342.50977,
						151.87500, 348.66211, 334.51172, 234.40430, 118.91602, 53.43750, 84.02344, 81.29883,
						170.68359, 168.13477, 277.91016, 284.23828, 147.56836, 90.26367, 34.62891, 114.08203,
						185.09766, 271.23047, 75.49805, 84.19922, 144.14062, 296.71875, 126.21094, 146.25000,
						105.55664, 202.67578, 119.17969, 13.88672, 132.01172, 166.72852, 97.73437, 49.92188
						];
					break;

				case Math.pow(2,17):
					// Sampling frequency:          19530000 Hz
					// Mean frequency spacing:        100000 Hz
					// 1-sigma frequency dispersion:    2000 Hz
					// Frequency grid:                   149 Hz
					// Crest factor: 3.73
					// Set of carrier frequencies (Hz):
					freqtab=[
						1000548.93494, 1098294.29626, 1199615.70740, 1302278.13721, 1401364.51721, 1501940.91797, 1601474.30420, 1700709.68628,
						1801733.09326, 1902756.50024, 2001395.87402, 2098992.23328, 2199717.63611, 2296419.98291, 2399678.42102, 2500105.81970,
						2597702.17896, 2695298.53821, 2801239.01367, 2903752.44141, 3001944.80896, 3101627.19727, 3196243.51501, 3297564.92615,
						3404697.41821, 3499164.73389, 3601827.16370, 3698529.51050, 3799403.91541, 3900129.31824, 4000854.72107, 4105603.17993,
						4199027.48108, 4300646.89636, 4400627.28882, 4505971.75598, 4604909.13391, 4700270.46204, 4796674.80469, 4897400.20752
						];
					// Set of carrier initial phases (Deg):
					phitab=[
						19.42383, 281.16211, 256.20117, 320.27344, 4.74609, 143.61328, 10.54687, 40.86914,
						309.90234, 61.96289, 220.07812, 267.18750, 251.80664, 25.92773, 186.67969, 164.35547,
						36.65039, 333.89648, 90.79102, 170.06836, 354.02344, 308.14453, 27.50977, 122.95898,
						267.53906, 70.31250, 77.69531, 44.82422, 241.69922, 298.65234, 205.83984, 259.62891,
						33.04688, 206.19141, 65.30273, 95.18555, 234.75586, 320.36133, 149.94141, 331.43555
						];
					break;

				case Math.pow(2,18):
					// Sampling frequency:          19530000 Hz
					// Mean frequency spacing:        100000 Hz
					// 1-sigma frequency dispersion:    2000 Hz
					// Frequency grid:                    74 Hz
					// Crest factor: 3.85
					// Set of carrier frequencies (Hz):
					freqtab=[
						1000846.93909, 1093079.22363, 1198349.18976, 1297137.56561, 1396596.45081, 1500450.89722, 1599984.28345, 1699890.17487,
						1799423.56110, 1901564.48364, 1996776.80969, 2103685.79865, 2199345.13092, 2298357.00989, 2397666.89301, 2499435.31036,
						2599862.70905, 2700811.61499, 2801984.02405, 2902783.92792, 2999560.77576, 3100137.17651, 3199298.05756, 3301513.48114,
						3401270.37048, 3500803.75671, 3603317.18445, 3698306.00739, 3799403.91541, 3902960.35767, 4001674.23248, 4096588.55438,
						4201039.00909, 4300497.89429, 4399435.27222, 4499490.16571, 4598725.54779, 4700866.47034, 4798090.32440, 4895761.18469
						];
					// Set of carrier initial phases (Deg):
					phitab=[
						160.31250, 293.90625, 292.93945, 11.25000, 241.87500, 232.55859, 12.12891, 163.82812,
						308.84766, 45.26367, 325.01953, 215.15625, 55.28320, 92.81250, 132.80273, 330.55664,
						158.29102, 168.83789, 189.22852, 356.57227, 122.25586, 185.36133, 199.33594, 153.54492,
						195.02930, 178.15430, 291.00586, 10.81055, 108.98438, 140.44922, 354.46289, 191.42578,
						11.51367, 61.34766, 255.84961, 229.48242, 8.70117, 217.79297, 358.06641, 26.27930
						];
					break;

				case Math.pow(2,19):
					// Sampling frequency:          19530000 Hz
					// Mean frequency spacing:        100000 Hz
					// 1-sigma frequency dispersion:    2000 Hz
					// Frequency grid:                    37 Hz
					// Crest factor: 4.09
					// Set of carrier frequencies (Hz):
					freqtab=[
						1000995.94116, 1103211.36475, 1200472.46933, 1301942.88254, 1398272.72415, 1499631.38580, 1600692.04330, 1699852.92435,
						1802403.60260, 1897690.42969, 2000650.86365, 2100407.75299, 2202064.41879, 2301635.05554, 2404707.24106, 2495710.25848,
						2599564.70490, 2700439.10980, 2798445.22476, 2898053.11203, 3002056.56052, 3099578.41873, 3199447.05963, 3299762.70676,
						3400860.61478, 3498009.96780, 3595494.57550, 3696592.48352, 3799292.16385, 3901433.08640, 3999364.70032, 4101319.37027,
						4196270.94269, 4298709.86938, 4400999.79401, 4498111.89651, 4600066.56647, 4701834.98383, 4802895.64133, 4896357.19299
						];
					// Set of carrier initial phases (Deg):
					phitab=[
						28.03711, 338.99414, 105.73242, 49.92188, 105.38086, 322.91016, 208.56445, 205.75195,
						139.92188, 183.25195, 100.72266, 244.51172, 325.81055, 266.48438, 135.00000, 310.25391,
						320.18555, 161.71875, 306.12305, 215.77148, 158.90625, 185.53711, 45.79102, 13.09570,
						320.97656, 107.40234, 44.47266, 98.26172, 349.54102, 29.26758, 1.75781, 17.66602,
						66.18164, 15.38086, 128.23242, 254.79492, 348.04688, 258.66211, 56.25000, 101.60156
						];
					break;

				case Math.pow(2,20):
					// Sampling frequency:          19530000 Hz
					// Mean frequency spacing:        100000 Hz
					// 1-sigma frequency dispersion:    2000 Hz
					// Frequency grid:                    18 Hz
					// Crest factor: 4.21
					// Set of carrier frequencies (Hz):
					freqtab=[
						998574.65744, 1101851.72081, 1200695.97244, 1300098.98186, 1396168.06984, 1500078.39203, 1597302.24609, 1696034.74617,
						1801844.84482, 1897355.17502, 1998676.58615, 2102456.53152, 2200965.52849, 2299549.02649, 2402304.58260, 2499751.93977,
						2601389.98032, 2697589.44511, 2796526.82304, 2897587.48055, 3000845.91866, 3100118.55125, 3196839.52332, 3296540.53688,
						3399966.60233, 3500356.75049, 3601100.77858, 3701677.17934, 3799124.53651, 3898583.42171, 3995360.26955, 4102772.14050,
						4197928.59077, 4298504.99153, 4399211.76910, 4499862.67090, 4599321.55609, 4699395.07484, 4803752.40326, 4899691.11443
						];
					// Set of carrier initial phases (Deg):
					phitab=[
						255.23438, 353.14453, 201.79688, 164.61914, 230.44922, 148.09570, 177.89062, 190.54687,
						333.45703, 115.04883, 270.00000, 216.38672, 72.24609, 213.75000, 67.41211, 175.51758,
						49.04297, 47.37305, 333.98438, 269.91211, 123.04688, 243.01758, 271.05469, 208.65234,
						208.30078, 181.49414, 150.20508, 168.92578, 231.76758, 232.64648, 221.04492, 110.74219,
						224.03320, 108.54492, 357.89062, 30.14648, 201.26953, 309.02344, 314.73633, 349.71680
						];
					break;
				}
				freqtab = freqtab.slice(0, nbcarriers);
				phitab = phitab.slice(0, nbcarriers);
		}

	print_freq_tab(freqtab);
	print_phi_tab(phitab);
		
	return {
		FREQtab: freqtab,
		PHIItab: phitab
		};
	}

////////////////////////////////////////////////////////////////////////////////

function carrier_freq(Spread, Fgrid, nbcarriers)
// This function computes the set of carrier frequencies
	{
	switch (Spread) {
		case "No":
			// Definition of LC resonance frequencies: 100.0 kHz step and  0.0 kHz dispersion @ 1 sigma
			print("No spread around ideal 100kHz grid")
			FREQtab = [
				1000000.00, 1100000.00, 1200000.00, 1300000.00, 1400000.00, 1500000.00, 1600000.00, 1700000.00,
				1800000.00, 1900000.00, 2000000.00, 2100000.00, 2200000.00, 2300000.00, 2400000.00, 2500000.00,
				2600000.00, 2700000.00, 2800000.00, 2900000.00, 3000000.00, 3100000.00, 3200000.00, 3300000.00,
				3400000.00, 3500000.00, 3600000.00, 3700000.00, 3800000.00, 3900000.00, 4000000.00, 4100000.00,
				4200000.00, 4300000.00, 4400000.00, 4500000.00, 4600000.00, 4700000.00, 4800000.00, 4900000.00,
				]
			break
		case "Normal":
			// Definition of LC resonance frequencies: 100.0 kHz step and  2.0 kHz dispersion @ 1 sigma
			print("Normal spread around ideal 100kHz grid")
			FREQtab = [
				996704.86, 1097653.73, 1197333.15, 1301868.92, 1400987.31, 1500698.06, 1596579.61, 1697836.03,
				1794853.56, 1901259.85, 1999130.86, 2101956.92, 2200656.92, 2299750.19, 2400616.07, 2499278.93,
				2598731.30, 2701501.05, 2798540.48, 2903169.11, 2998998.49, 3099093.41, 3198765.55, 3297652.76,
				3398986.46, 3501151.12, 3602702.04, 3702049.53, 3797144.36, 3899066.58, 4001907.83, 4099602.47,
				4200198.73, 4301944.65, 4398899.80, 4501899.92, 4602836.70, 4699252.43, 4797968.19, 4900545.02,
				]
			break
		case "Huge":
			// Definition of LC resonance frequencies: 100.0 kHz step and  5.0 kHz dispersion @ 1 sigma
			print("Huge spread around ideal 100kHz grid")
			FREQtab = [
				1002656.49, 1102642.86, 1199864.85, 1304155.35, 1408462.12, 1496696.95, 1597934.81, 1703763.20,
				1799162.90, 1892685.25, 2006563.03, 2097925.96, 2206107.51, 2299695.00, 2395534.38, 2512506.79,
				2596784.44, 2696679.10, 2794153.82, 2900068.66, 2992240.22, 3089285.15, 3205906.49, 3304381.29,
				3399724.42, 3501857.99, 3600557.53, 3702984.09, 3803244.73, 3899462.84, 4007617.30, 4104209.38,
				4197136.25, 4299587.03, 4409470.87, 4500047.15, 4601632.49, 4698735.13, 4802668.38, 4906147.21,
				]
			break
		}

	for(i=0;i<nbcarriers;i++){            // This loop aligns the firmware frequencies on a frequency grid
		FREQtab[i] = Fgrid*(Math.round(FREQtab[i]/Fgrid))
		PHIItab[i] = (Math.PI*i*i/Npix)*180/Math.PI  // apply the Schroeder's minus relation defined in eq (6.10) in page 163 of the Bible
		}

	print_freq_tab(FREQtab.slice(0, nbcarriers));
	print_phi_tab(PHIItab.slice(0, nbcarriers));

	return {
			FREQtab: FREQtab.slice(0, nbcarriers),
			PHIItab: PHIItab.slice(0, nbcarriers)
			};	
	}

////////////////////////////////////////////////////////////////////////////////

function print_freq_tab(FREQtab)
// This function print a set of nfrequencies
	{
	print("")
	print(">>---------------------------------------------------------")
	print("The values of the carrier frequencies set in the firmware are:")
	Ncol=8
	Nlines=5
	for(line=0;line<Nlines;line++)
		{
		for(linestring='', col=0;col<Ncol;col++)
			{
			if (line*Ncol+col < FREQtab.length)
				{
				freq=("       "+parseInt(FREQtab[line*Ncol+col]).toString()).slice(-7)+"Hz    "
				linestring=linestring+freq
				}
			}
		print(linestring)
		}
	}

////////////////////////////////////////////////////////////////////////////////

function print_phi_tab(PHIItab)
// This function print a set of nfrequencies
	{
	print("")
	print("The values of the initial phases set in the firmware are:")
	Ncol=8
	Nlines=5
	for(line=0;line<Nlines;line++)
		{
		for(linestring='', col=0;col<Ncol;col++)
			{
			if (line*Ncol+col < PHIItab.length)
				{
				phi=("   "+parseInt(PHIItab[line*Ncol+col]).toString()).slice(-3)+"deg    "
				linestring=linestring+phi
				}
			}
		print(linestring)
		}
	}

////////////////////////////////////////////////////////////////////////////////
