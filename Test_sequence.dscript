include("./Tools.dscript")

////////////////////////////////////////////////////////////////////////////////
// Test sequence
////////////////////////////////////////////////////////////////////////////////
function test_sequence(
	session_name,
	session_comment,
	operator_name,
	Channel_ID,
	Default_amp,
	test_pix_index,
	amp_pixel_test,
	SQUID_interne,
	Gain,
	BIAS_trunc,
	FBCK_trunc,
	FBCK_gain,
	dacMode,
	FS,
	DoGBW,
	DoScienceSpectra,
	DoScienceSpectra20Msps,
	nbr_spectra,
	spectra_duration_ms,
	DoEnergyResol,
	PixelType,
	ER_nbr_pulses_calib,
	ER_nbr_pulses_meas,
	ER_nbr_files,
	Threshold,
	ModulationRatio,
	TES_NL,
	saveIQ
	)
// This function makes one test sequence for a set of parameters
{
	// Opening the session
	sendStartSession(session_name, session_comment)
	// Saving test parameters in a file
	setAndMemorize( "session_name", session_name)
	setAndMemorize( "session_comment", session_comment)
	setAndMemorize( "operator_name", operator_name)
	setAndMemorize( "Channel_ID", Channel_ID)
	setAndMemorize( "Default_amp", Default_amp)
	setAndMemorize( "test_pix_index", test_pix_index)
	setAndMemorize( "amp_pixel_test", amp_pixel_test)
	setAndMemorize( "SQUID_interne", SQUID_interne)
	setAndMemorize( "Gain", Gain)
	setAndMemorize( "BIAS_trunc", BIAS_trunc)
	setAndMemorize( "FBCK_trunc", FBCK_trunc)
	setAndMemorize( "FBCK_gain", FBCK_gain)
	setAndMemorize( "dacMode", dacMode)
	setAndMemorize( "FS", FS)
	setAndMemorize( "DoGBW"	, DoGBW)
	setAndMemorize( "DoScienceSpectra", DoScienceSpectra)
	setAndMemorize( "DoScienceSpectra20Msps", DoScienceSpectra20Msps)
	setAndMemorize( "nbr_spectra", nbr_spectra)
	setAndMemorize( "spectra_duration_ms", spectra_duration_ms)
	setAndMemorize( "DoEnergyResol", DoEnergyResol)
	setAndMemorize( "PixelType", PixelType)
	setAndMemorize( "ER_nbr_pulses_calib", ER_nbr_pulses_calib)
	setAndMemorize( "ER_nbr_pulses_meas", ER_nbr_pulses_meas)
	setAndMemorize( "ER_nbr_files", ER_nbr_files)
	setAndMemorize( "Threshold", Threshold)
	setAndMemorize( "ModulationRatio", ModulationRatio)
	setAndMemorize( "TES_NL", TES_NL)
	setAndMemorize( "saveIQ", saveIQ)

	copyFileToBackupDir(getEGSEDirectory()+"\\parametersTF.dispatcher","HK\\parametersTF.dispatcher")  // copy HK limits
	
	// Sauvegarde des scripts
	getLatestValue("DISP_BackupsCurrentDirectory")
	mkpath(DISP_BackupsCurrentDirectory+"\\OUTPUTS")
	mkpath(DISP_BackupsCurrentDirectory+"\\SCRIPTS_GSE\\demux-perfs-js")
	copyFileToBackupDir(".\\Launcher.dscript","\\SCRIPTS_GSE\\demux-perfs-js\\Launcher.dscript") 
	copyFileToBackupDir(".\\Tools.dscript","\\SCRIPTS_GSE\\demux-perfs-js\\Tools.dscript") 
	copyFileToBackupDir(".\\Startup.dscript","\\SCRIPTS_GSE\\demux-perfs-js\\Startup.dscript") 
	copyFileToBackupDir(".\\Configs.dscript","\\SCRIPTS_GSE\\demux-perfs-js\\Configs.dscript") 
	copyFileToBackupDir(__FILE__,"\\SCRIPTS_GSE\\demux-perfs-js\\"+__FILE__.split("/").pop()) // sauvegarde du script courant
	copyDirToBackupDir(getEGSEDirectory()+"\\EP",".\\EP_PARAMETERS")	

	saveMemorizedParametersToBackupDir("SCRIPTS_GSE\\demux-perfs-js\\"+__FILE__.split("/").pop().split(".")[0]+"_PARAMETERS.txt")
	
	////// Defining the carrier frequencies
	// Sampling frequency:          19530000 Hz
	// Mean frequency spacing:        100000 Hz
	// 1-sigma frequency dispersion:    2000 Hz
	// Frequency grid:                  1192 Hz
	// Crest factor: 3.15
	// Set of carrier frequencies (Hz):
	FREQtab=[
		1002485.96191, 1096655.27344, 1199168.70117, 1300490.11230, 1399427.49023, 1499556.88477, 1597302.24609, 1697431.64062,
		1797561.03516, 1896498.41309, 2001395.87402, 2100333.25195, 2200462.64648, 2298208.00781, 2400721.43555, 2496082.76367,
		2600980.22461, 2699917.60254, 2802431.03027, 2902560.42480, 3001497.80273, 3100435.18066, 3196988.52539, 3299501.95312,
		3399631.34766, 3498568.72559, 3599890.13672, 3701211.54785, 3801340.94238, 3901470.33691, 3998023.68164, 4102921.14258,
		4200666.50391, 4297219.84863, 4398541.25977, 4498670.65430, 4602376.09863, 4702505.49316, 4799058.83789, 4896804.19922
		];
	// Set of carrier initial phases (Deg):
	PHIItab=[
		188.96484, 231.59180, 303.48633, 74.79492, 75.76172, 29.17969, 347.25586, 350.06836,
		130.42969, 350.68359, 43.06641, 205.75195, 30.84961, 223.85742, 69.52148, 308.75977,
		128.40820, 154.95117, 82.52930, 82.88086, 165.49805, 142.73438, 137.28516, 339.16992,
		49.13086, 167.69531, 279.31641, 110.83008, 38.49609, 36.82617, 276.76758, 42.09961,
		119.53125, 200.12695, 69.78516, 225.08789, 347.51953, 283.00781, 348.31055, 184.13086
		];
	
	// Resetting the DEMUX firmware
	DRE_resetAll()

	// Measurement of housekeepings
	Start_HK_collection()

	// Configuration of the DEMUX firmware (channels)
	Channel_0_conf=define_Channel_conf(
		Loop_Control=0,
		StartStop=0,
		Nonlinear_ON=0,
		Manual_Delock=0,
		Delock_ON=0,
		ADC_ON=1,
		DACB_ON=1,
		DACF_ON=1,
		Select_Input=SQUID_interne,
		Bias_Enabled=1,
		Feedback_Enabled=1,
		Bias_Slope_Speed=2,
		Bias_Truncation=BIAS_trunc,
		Feedback_Truncation=FBCK_trunc,
		Compensation_Gain=FBCK_gain,
		Feedback_Reverse=0,
		Wait_for_relock=7,  // (0..7)
		Delock_level=0x7FF  // (maximum positive value)
		)
	configure_DEMUX_channel(Channel_ID, Channel_0_conf)

	// Loading the pulse shape in the FPGA
	fake_pulse_timescale=load_pulse(PixelType)

	// Measurement of gain bandwidth product
	if (DoGBW) {
		ScanGBW(Channel_ID, Default_amp/2, Gain, FREQtab[test_pix_index])}
	
	// Configuration of the DEMUX firmware (pixels)
	configure_DEMUX_pixels(Channel_ID, Default_amp, Gain, FREQtab, PHIItab, test_pix_index, amp_pixel_test)

	//  Start DEMUX
	sendStartDREChannels(3)
	waitMs(1000)            // Wait for the ramp

	// Measurement of the data dumps
	mk_dumps(Channel_ID, 1000)

	// Measurement of IQ files for spectra characterisation
	if (DoScienceSpectra) {
	mk_science_data_files(Channel_ID, nbr_spectra, spectra_duration_ms, DoScienceSpectra20Msps)}

	// Checking pulse shape on different signals 
	check_pulses(Channel_ID, ModulationRatio, fake_pulse_timescale)

	if (DoEnergyResol){
	// Measurement of energy resolution
	mk_energy_resol_tst(Channel_ID, ER_nbr_pulses_calib, ER_nbr_pulses_meas, ER_nbr_files, ModulationRatio, Threshold, saveIQ, fake_pulse_timescale)}

	Stop_HK_collection()
	saveLogToBackupDir("scriptlog.txt")
	sendStopSession()

	onAbortScript()

	print("Processing data ...")
	output = copyDirToBackupDirAndExecuteBat("..\\..\\SCRIPTS_PYTHON\\demux-perfs-py",".\\SCRIPTS_PYTHON\\demux-perfs-py","python-perfs.bat")
	addToFile(output)

	print("Compressing data ...")
	zipData()

	print("End of session " + session_name)
}

////////////////////////////////////////////////////////////////////////////////
// Functions definitions
////////////////////////////////////////////////////////////////////////////////

function configure_DEMUX_channel(Channel_ID, conf)
// This function configures the channels parameters of the DEMUX firmware
{
	//// Channel settings
	Channel_CMD(
		Channel_id=Channel_ID,
		Loop_Control=conf.Loop_Control,
		StartStop=conf.StartStop,
		Nonlinear_ON=conf.Nonlinear_ON,
		Manual_Delock=conf.Manual_Delock,
		Delock_ON=conf.Delock_ON,
		ADC_ON=conf.ADC_ON,
		DACB_ON=conf.DACB_ON,
		DACF_ON=conf.DACF_ON,
		Select_Input=conf.Select_Input,
		Bias_Enabled=conf.Bias_Enabled,
		Feedback_Enabled=conf.Feedback_Enabled,
		Bias_Slope_Speed=conf.Bias_Slope_Speed,
		Bias_Truncation=conf.Bias_Truncation,
		Feedback_Truncation=conf.Feedback_Truncation,
		Compensation_Gain=conf.Compensation_Gain,
		Feedback_Reverse=conf.Feedback_Reverse,
		Wait_for_relock=conf.Wait_for_relock,
		Delock_level=conf.Delock_level
		)
}

////////////////////////////////////////////////////////////////////////////////
function configure_DEMUX_pixels(Channel_ID, Amp, Gain, FREQtab, PHIItab, test_pix_index, amp_pixel_test)
// This function configures the pixels' parameters of the DEMUX firmware for the test
// In this configuration 39 standard pixels and the test pixel are used.
// Input parameters:
//		Amp: (number)
//			the amplitude of the pixels
//		FREQtab: (array)
//			the values of the carriers
//		test_pix_index: (number)
//			the index of the standard pixel to be replaced by the test pixel
//			if -1 the test pixel is switched off
{
	Ncar=FREQtab.length
	Reset_All_Configs(0)
	print("Standard pixels switched on")
	for(var Pixel_ID=0;Pixel_ID<Ncar;Pixel_ID++)
	{
		Set_Pixel_Config(
			Pixel_ID=Pixel_ID,
			PHI_Delay=-1,
			PHI_Rotate=0,
			Gain_BBFB=Gain,
			Bias_Amplitude=Amp,
			Frequency=FREQtab[Pixel_ID],
			PHI_Initial=PHIItab[Pixel_ID]
			)
	}

	////// Test pixel's settings
	Amp_test=Amp
	Freq_test=FREQtab[test_pix_index]
	Gain_test=Gain
	PhiIdeg_test = PHIItab[test_pix_index]
	PhiC_Testdeg = Get_PhiC(Freq_test)

	if (test_pix_index==-1) // switching test pixel off
	{
		print("switching test pixel off")
		Amp_test = 0
		Gain_test = 0
		Freq_test = 0
	}
	else
	{
		// Switch off the pixel where we will place the test pixel 
		print("switching standard pixel ", test_pix_index, " off")
		Set_Pixel_Off(test_pix_index)
	}

	Set_Pixel_Config(
		Pixel_ID=40,
		PHI_Delay=PhiC_Testdeg,
		PHI_Rotate=0,
		Gain_BBFB=Gain_test,
		Bias_Amplitude=Amp_test,
		Frequency=Freq_test,
		PHI_Initial=PhiIdeg_test
		)
	Set_TestPixel_ExtraCommands(
		modulation_freq=0,
		pulse_timescale=-1,
		pulse_amplitude=-1,
		pulse_start=-1,
		sw2=0,  // Feedback
		sw1=0,  // Closed loop
		modulation_amplitude=0
		)

	// Apply the pixels configuration 
	Update_All_Configs(0)
	Apply_All_Configs(0)		
}

////////////////////////////////////////////////////////////////////////////////
function Start_HK_collection()
{
	sendStartDREHkAcquisition(1)	// periodic HK from ADC (to be stopped at the end of the sequence)
}

////////////////////////////////////////////////////////////////////////////////
function Stop_HK_collection()
{
	sendStopDREHkAcquisition()
}

////////////////////////////////////////////////////////////////////////////////
function mk_dumps(Channel_ID, duration_ms)
// This function makes BIAS, INPUT and FEEDBACK dumps
// Input parameters:
//		duration_ms: number
//			duration of each dump
{
	print(">>---------------------------------------------------------")
	print(">>  Measuring ADC and DACs data dumps")

	START_DUMP("IN-BIA",0,Channel_ID,"")
	waitMs(duration_ms)
	STOP_DUMP()
	
	START_DUMP("IN-FBK",0,Channel_ID,"")
	waitMs(duration_ms)
	STOP_DUMP()
}

////////////////////////////////////////////////////////////////////////////////
function mk_science_data_files(Channel_ID, nbr_files, duration_ms, DoScienceSpectra20Msps)
// This function makes a series of science data files in order to measure the science data spectra
// Input parameters:
//		duration_ms: (number)
//			duration of each dump
//		nbr_spectra: (number)
//			the number of files to measure
{
	print("")
	print(">>---------------------------------------------------------")
	print(">>  Measurement of IQ data files for spectra measurement:")
	for(i=0;i<nbr_files;i++){
		//Dump IQ-ALL (all pixels filtered and data @ 156ksps)
		START_DUMP("IQ-ALL",i,Channel_ID,"_Science-Data")        // ( dump_type, i, channelID, filename_comment )
		waitMs(duration_ms)
		STOP_DUMP()
	}

	if (DoScienceSpectra20Msps){
		for(i=0;i<nbr_files;i++){
			//Dump IQ-TST (test pixel - data @ 20Msps)
			START_DUMP("IQ-TST",i,Channel_ID,"_Science-Data")        // ( dump_type, i, channelID, filename_comment )
			waitMs(duration_ms)
			STOP_DUMP()
		}
	}
}

////////////////////////////////////////////////////////////////////////////////
function check_pulses(Channel_id, ModulationRatio,pulse_timescale)
// This function makes the measurements necessary to estimate the energy resolution
{
	print("")
	print(">>---------------------------------------------------------")
	print(">>  Measuring ADC and BIAS dumps with pulses")
	START_DUMP("IN-BIA" ,0,Channel_id,"_PULSE")
	sendPulsesAndWaitingForInjectionDone(Channel_id,10,50,ModulationRatio,pulse_timescale)
	STOP_DUMP()
		
	print("")
	print(">>---------------------------------------------------------")
	print(">>  Measuring IQ dumps with pulses")
	START_DUMP("IQ-ALL" ,0,Channel_id,"_PULSE")
	sendPulsesAndWaitingForInjectionDone(Channel_id,10,50,ModulationRatio,pulse_timescale)
	STOP_DUMP()
}

////////////////////////////////////////////////////////////////////////////////
function mk_energy_resol_tst(Channel_id,  Npulses_calib,  Npulses_meas, ER_nbr_files, ModulationRatio, Threshold, saveIQ, pulse_timescale)
// This function makes the measurements necessary to estimate the energy resolution
{	
	print("")
	print(">>---------------------------------------------------------")
	print(">>  Collecting data to build the EP filter")

	print("  - Measuring noise records...")
	sendStartDREDaqAcquisition(8) // IQ-ALL
	sendStartRecordBackup(2000,maDate()+"_mk_EP_filter_noise_record.fits")
	waitingForEndOfRecord()
	sendStopDumpedDataBackup()

	print("  - Measuring event records...")
	sendStartEventProcessor(0,"mk_EP_filter",Threshold)
	if (saveIQ)
		{
		print("        Saving IQ data")
		sendStartDumpedDataBackup2Filename(0, maDate()+"_EP_events.dat","")
		}		
	sendPulsesAndWaitingForInjectionDone(Channel_id,Npulses_calib,65,ModulationRatio,pulse_timescale)
	sendStopEventProcessor()
	sendStopDumpedDataBackup()

	print(">>  Measuring energy resolution")
	
	for (measure=0; measure<ER_nbr_files; measure++)
	{
		print("  - PULSE Measurements ("+(measure+1).toString()+" / "+ER_nbr_files.toString()+"): ")
		sendStartEventProcessor(0,"meas_E_resol",Threshold)
		if (saveIQ)
			{
			print("        Saving IQ data")
			sendStartDumpedDataBackup2Filename(0, maDate()+"_EP_measure.dat","")
			}		
		sendPulsesAndWaitingForInjectionDone(Channel_id,Npulses_meas,65,ModulationRatio,pulse_timescale)
		sendStopEventProcessor()
		sendStopDumpedDataBackup()
	}
	sendStopDREDaqAcquisition()
}

	
////////////////////////////////////////////////////////////////////////////////
function clean_stop()
{
	print(">>---------------------------------------------------------")
	sendStopDREPulses()
	sendStopEventProcessor()
	sendStopDREHkAcquisition()
	sendStopDREChannels(3)
	sendStopDumpedDataBackup()
}

////////////////////////////////////////////////////////////////////////////////
function onAbortScript()
// This function is called when clicking on the "Abort" button
// It is used to abort the setup in a proper way
{
	clean_stop()
	sendStopSession()
}

////////////////////////////////////////////////////////////////////////////////
